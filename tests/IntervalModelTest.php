<?php
use \PHPUnit\Framework\TestCase;

require_once("../src/defines.php");
require_once(SRC_ROOT . "/IntervalModel.php");
require_once(SRC_ROOT . "/Interval.php");

class IntervalModelTest extends TestCase
{
    /**
     * @var IntervalModel
     */
    private $model;

    /**
     * @throws Exception
     */
    private function prepare() {
        $this->model = new IntervalModel();
        $this->model->setTable(IntervalModel::TABLE_TEST);
        $this->model->getDbManager()->query("DROP TABLE IF exists `{$this->model->getTable()}`");
        $this->model->getDbManager()->query("CREATE TABLE `{$this->model->getTable()}` LIKE `".IntervalModel::TABLE_DEFAULT."`;");
        $this->model->getDbManager()->setProfilingEnabled(true);
    }

    /**
     * Test data consists of two groups:
     *  1) List of intervals that will be added consistently
     *  2) List of intervals that will be present in the table after all operations done
     *  3) Number of expected MySQL data mutations (Insert, Update, Delete) while adding latest interval from list 1
     * @return array
     */
    public function dataProvider() {

        return [

            /**
             * Base intersection group
             * All combinations of intersections with single interval and 2 prices variations
             *
             * 1)
             * --a===b------
             * ------a===b--
             */
            [
                [
                    [5,  10, 100], // 1. Add interval 2-10, price 100
                    [10, 20, 100], // 2. Add interval 10-20, price 100
                ],
                [
                    [5, 20, 100], // Now db should keep single 5-20, price 100 interval
                ],
                1 // Expected 1 DB modification operation (single update) when adding latest interval (10-20, price 100)
            ],
            [
                [
                    [5,  10, 75],
                    [10, 20, 100],
                ],
                [
                    [5,  10, 75],
                    [10, 20, 100],
                ],
                1
            ],
            /**
             * 2)
             * ----a===b----
             * ------a===b--
             */
            [
                [
                    [5,  12, 100],
                    [10, 20, 100],
                ],
                [
                    [5, 20, 100],
                ],
                1
            ],
            [
                [
                    [5,  12, 75],
                    [10, 20, 100],
                ],
                [
                    [5,  10, 75],
                    [10, 20, 100],
                ],
                2
            ],
            /**
             * 3)
             * ----a=====b--
             * ------a===b--
             */
            [
                [
                    [10, 20, 100],
                    [12, 20, 100],
                ],
                [
                    [10, 20, 100],
                ], 0
            ],
            [
                [
                    [10, 20, 75],
                    [12, 20, 100],
                ],
                [
                    [10, 12, 75],
                    [12, 20, 100],
                ], 2
            ],
            /**
             * 4)
             * ---a=======b--
             * -----a===b----
             */
            [
                [
                    [10, 20, 100],
                    [12, 18, 100],
                ],
                [
                    [10, 20, 100],
                ], 0
            ],
            [
                [
                    [10, 20, 75],
                    [12, 18, 100],
                ],
                [
                    [10, 12, 75],
                    [12, 18, 100],
                    [18, 20, 75],
                ], 3
            ],
            /**
             * 5)
             * ---a=======b--
             * ---a=======b--
             */
            [
                [
                    [10, 20, 100],
                    [10, 20, 100],
                ],
                [
                    [10, 20, 100],
                ], 0
            ],
            [
                [
                    [10, 20, 75],
                    [10, 20, 100],
                ],
                [
                    [10, 20, 100],
                ], 1
            ],
            /**
             * 6)
             * ---a===b----
             * ---a======b-
             */
            [
                [
                    [10, 20, 100],
                    [10, 25, 100],
                ],
                [
                    [10, 25, 100],
                ], 1
            ],
            [
                [
                    [10, 20, 75],
                    [10, 25, 100],
                ],
                [
                    [10, 25, 100],
                ], 1
            ],
            /**
             * 7)
             * -----a===b---
             * ---a=======b-
             */
            [
                [
                    [10, 20, 100],
                    [8,  25, 100],
                ],
                [
                    [8, 25, 100],
                ], 1
            ],
            [
                [
                    [10, 20, 75],
                    [8,  25, 100],
                ],
                [
                    [8, 25, 100],
                ], 1
            ],
            /**
             * 8)
             * -------a===b-
             * ---a=======b-
             */
            [
                [
                    [10, 20, 100],
                    [8,  20, 100],
                ],
                [
                    [8, 20, 100],
                ], 1
            ],
            [
                [
                    [10, 20, 75],
                    [8,  20, 100],
                ],
                [
                    [8, 20, 100],
                ], 1
            ],
            /**
             * 9) (Reflection of 3)
             * ---a=======b-
             * ---a====b----
             */
            [
                [
                    [10, 25, 100],
                    [10, 20, 100],
                ],
                [
                    [10, 25, 100],
                ], 0
            ],
            [
                [
                    [10, 25, 75],
                    [10, 20, 100],
                ],
                [
                    [10, 20, 100],
                    [20, 25, 75],
                ], 2
            ],

            /**
             * 10)
             * ------a====b-
             * ---a====b----
             */
            [
                [
                    [10, 20, 100],
                    [5,  15, 100],
                ],
                [
                    [5, 20, 100],
                ], 1
            ],
            [
                [
                    [10, 20, 75],
                    [5,  15, 100],
                ],
                [
                    [5,  15, 100],
                    [15, 20, 75],
                ], 2
            ],
            /**
             * 11)
             * -------a====b-
             * --a====b------
             */
            [
                [
                    [10, 20, 100],
                    [3,  10, 100],
                ],
                [
                    [3, 20, 100],
                ], 1
            ],
            [
                [
                    [10, 20, 75],
                    [3,  10, 100],
                ],
                [
                    [3,  10, 100],
                    [10, 20, 75],
                ], 1
            ],


            /**
             * All intersections with two interval groups
             * and all possible price combinations
             *
             * 1a)
             * --a===b--a==b----
             * ------a=======b--
             */
            [
                [
                    [10, 15, 100],
                    [20, 25, 100],
                    [15, 28, 100],
                ],
                [
                    [10,  28, 100],
                ], 2
            ],
            [
                [
                    [10, 15, 75],
                    [20, 25, 100],
                    [15, 28, 100],
                ],
                [
                    [10, 15, 75],
                    [15, 28, 100],
                ], 1
            ],
            [
                [
                    [10, 15, 75],
                    [20, 25, 75],
                    [15, 28, 100],
                ],
                [
                    [10, 15, 75],
                    [15, 28, 100],
                ], 1
            ],
            [
                [
                    [10, 15, 100],
                    [20, 25, 75],
                    [15, 28, 100],
                ],
                [
                    [10, 28, 100],
                ], 2
            ],
            /**
             * 1b)
             * --a===c==b----
             * ------a=====b-
             */
            [
                [
                    [10, 15, 100],
                    [15, 20, 75],
                    [15, 28, 100],
                ],
                [
                    [10, 28, 100],
                ], 2
            ],
            [
                [
                    [10, 15, 75],
                    [15, 20, 100],
                    [15, 28, 100],
                ],
                [
                    [10, 15, 75],
                    [15, 28, 100],
                ], 1
            ],
            /**
             * 1c)
             * --a===c=====b-
             * ------a=====b-
             */
            [
                [
                    [10, 15, 100],
                    [15, 20, 75],
                    [15, 20, 100],
                ],
                [
                    [10, 20, 100],
                ], 2
            ],
            [
                [
                    [10, 15, 75],
                    [15, 20, 100],
                    [15, 20, 100],
                ],
                [
                    [10, 15, 75],
                    [15, 20, 100],
                ], 0
            ],
            /**
             * 1d)
             * --a===c=======b-
             * ------a=====b---
             */
            [
                [
                    [10, 15, 100],
                    [15, 25, 75],
                    [15, 20, 100],
                ],
                [
                    [10, 20, 100],
                    [20, 25, 75],
                ], 2
            ],
            [
                [
                    [10, 15, 75],
                    [15, 25, 100],
                    [15, 20, 100],
                ],
                [
                    [10, 15, 75],
                    [15, 25, 100],
                ], 0
            ],
            /**
             * 1e)
             * -a==b--a===b-
             * ----a======b-
             */
            [
                [
                    [10, 15, 100],
                    [20, 25, 100],
                    [15, 25, 100],
                ],
                [
                    [10, 25, 100],
                ], 2
            ],
            [
                [
                    [10, 15, 100],
                    [20, 25, 75],
                    [15, 25, 100],
                ],
                [
                    [10, 25, 100],
                ], 2
            ],
            [
                [
                    [10, 15, 75],
                    [20, 25, 100],
                    [15, 25, 100],
                ],
                [
                    [10, 15, 75],
                    [15, 25, 100],
                ], 1
            ],
            [
                [
                    [10, 15, 75],
                    [20, 25, 75],
                    [15, 25, 100],
                ],
                [
                    [10, 15, 75],
                    [15, 25, 100],
                ], 1
            ],
            /**
             * 1f)
             * -a==b--a=====b-
             * ----a======b---
             */
            [
                [
                    [10, 15, 100],
                    [20, 25, 100],
                    [15, 23, 100],
                ],
                [
                    [10, 25, 100],
                ], 2
            ],
            [
                [
                    [10, 15, 75],
                    [20, 25, 100],
                    [15, 23, 100],
                ],
                [
                    [10, 15, 75],
                    [15, 25, 100],
                ], 1
            ],
            [
                [
                    [10, 15, 75],
                    [20, 25, 75],
                    [15, 23, 100],
                ],
                [
                    [10, 15, 75],
                    [15, 23, 100],
                    [23, 25, 75],
                ], 2
            ],
            [
                [
                    [10, 15, 100],
                    [20, 25, 75],
                    [15, 23, 100],
                ],
                [
                    [10, 23, 100],
                    [23, 25, 75],
                ], 2
            ],
            /**
             * 1g)
             * -a==b----a==b-
             * ----a====b----
             */
            [
                [
                    [10, 15, 100],
                    [20, 25, 100],
                    [15, 20, 100],
                ],
                [
                    [10, 25, 100],
                ], 2
            ],
            [
                [
                    [10, 15, 75],
                    [20, 25, 100],
                    [15, 20, 100],
                ],
                [
                    [10, 15, 75],
                    [15, 25, 100],
                ], 1
            ],
            [
                [
                    [10, 15, 100],
                    [20, 25, 75],
                    [15, 20, 100],
                ],
                [
                    [10, 20, 100],
                    [20, 25, 75],
                ], 1
            ],
            [
                [
                    [10, 15, 75],
                    [20, 25, 75],
                    [15, 20, 100],
                ],
                [
                    [10, 15, 75],
                    [15, 20, 100],
                    [20, 25, 75],
                ], 1
            ],
            /**
             * 2a)
             * -a====c===b-
             * ----a=====b-
             */
            [
                [
                    [10, 15, 100],
                    [15, 20, 75],
                    [13, 20, 100],
                ],
                [
                    [10, 20, 100],
                ], 2
            ],
            [
                [
                    [10, 15, 75],
                    [15, 20, 100],
                    [13, 20, 100],
                ],
                [
                    [10, 13, 75],
                    [13, 20, 100],
                ], 2
            ],
            /**
             * 2b)
             * -a====c===b---
             * ----a=======b-
             */
            [
                [
                    [10, 15, 100],
                    [15, 20, 75],
                    [13, 25, 100],
                ],
                [
                    [10, 25, 100],
                ], 2
            ],
            [
                [
                    [10, 15, 75],
                    [15, 20, 100],
                    [13, 25, 100],
                ],
                [
                    [10, 13, 75],
                    [13, 25, 100],
                ], 2
            ],
            /**
             * 2c)
             * -a====c=======b--
             * ----a=======b----
             */
            [
                [
                    [10, 15, 100],
                    [15, 25, 75],
                    [13, 20, 100],
                ],
                [
                    [10, 20, 100],
                    [20, 25, 75],
                ], 2
            ],
            [
                [
                    [10, 15, 75],
                    [15, 25, 100],
                    [13, 20, 100],
                ],
                [
                    [10, 13, 75],
                    [13, 25, 100],
                ], 2
            ],
            /**
             * 2d)
             * -a===b--a=b---
             * ---a========b-
             */
            [
                [
                    [10, 15, 100],
                    [20, 25, 100],
                    [13, 30, 100],
                ],
                [
                    [10, 30, 100],
                ], 2
            ],
            [
                [
                    [10, 15, 100],
                    [20, 25, 75],
                    [13, 30, 100],
                ],
                [
                    [10, 30, 100],
                ], 2
            ],
            [
                [
                    [10, 15, 75],
                    [20, 25, 100],
                    [13, 30, 100],
                ],
                [
                    [10, 13, 75],
                    [13, 30, 100],
                ], 2
            ],
            [
                [
                    [10, 15, 75],
                    [20, 25, 75],
                    [13, 30, 100],
                ],
                [
                    [10, 13, 75],
                    [13, 30, 100],
                ], 2
            ],
            /**
             * 2e)
             * -a===b--a===b-
             * ---a========b-
             */
            [
                [
                    [10, 15, 100],
                    [20, 25, 100],
                    [13, 25, 100],
                ],
                [
                    [10, 25, 100],
                ], 2
            ],
            [
                [
                    [10, 15, 100],
                    [20, 25, 75],
                    [13, 25, 100],
                ],
                [
                    [10, 25, 100],
                ], 2
            ],
            [
                [
                    [10, 15, 75],
                    [20, 25, 100],
                    [13, 25, 100],
                ],
                [
                    [10, 13, 75],
                    [13, 25, 100],
                ], 2
            ],
            [
                [
                    [10, 15, 75],
                    [20, 25, 75],
                    [13, 25, 100],
                ],
                [
                    [10, 13, 75],
                    [13, 25, 100],
                ], 2
            ],
            /**
             * 2f)
             * -a===b--a===b-
             * ---a======b---
             */
            [
                [
                    [10, 15, 100],
                    [25, 30, 100],
                    [13, 28, 100],
                ],
                [
                    [10, 30, 100],
                ], 2
            ],
            [
                [
                    [10, 15, 75],
                    [25, 30, 100],
                    [13, 28, 100],
                ],
                [
                    [10, 13, 75],
                    [13, 30, 100],
                ], 2
            ],
            [
                [
                    [10, 15, 100],
                    [25, 30, 75],
                    [13, 28, 100],
                ],
                [
                    [10, 28, 100],
                    [28, 30, 75],
                ], 2
            ],
            [
                [
                    [10, 15, 75],
                    [25, 30, 75],
                    [13, 28, 100],
                ],
                [
                    [10, 13, 75],
                    [13, 28, 100],
                    [28, 30, 75],
                ], 3
            ],
            /**
             * 2g)
             * -a===b---a==b-
             * ---a=====b----
             */
            [
                [
                    [10, 15, 100],
                    [25, 30, 100],
                    [13, 25, 100],
                ],
                [
                    [10, 30, 100],
                ], 2
            ],
            [
                [
                    [10, 15, 75],
                    [25, 30, 100],
                    [13, 25, 100],
                ],
                [
                    [10, 13, 75],
                    [13, 30, 100],
                ], 2
            ],
            [
                [
                    [10, 15, 100],
                    [25, 30, 75],
                    [13, 25, 100],
                ],
                [
                    [10, 25, 100],
                    [25, 30, 75],
                ], 1
            ],
            [
                [
                    [10, 15, 75],
                    [25, 30, 75],
                    [13, 25, 100],
                ],
                [
                    [10, 13, 75],
                    [13, 25, 100],
                    [25, 30, 75],
                ], 2
            ],
            /**
             * 3a) Only one uncovered case
             * -a======c===b-
             * ----a===b-----
             */
            [
                [
                    [10, 20, 100],
                    [20, 30, 75],
                    [15, 20, 100],
                ],
                [
                    [10, 20, 100],
                    [20, 30, 75],
                ], 0
            ],
            [
                [
                    [10, 20, 75],
                    [20, 30, 100],
                    [15, 20, 100],
                ],
                [
                    [10, 15, 75],
                    [15, 30, 100],
                ], 2
            ],
            /**
             * 4 - no cases with two intervals
             *
             * 5a)
             * -a=====c==b-
             * -a=====b----
             */
            [
                [
                    [10, 20, 100],
                    [20, 30, 75],
                    [10, 20, 100],
                ],
                [
                    [10, 20, 100],
                    [20, 30, 75],
                ], 0
            ],
            [
                [
                    [10, 20, 75],
                    [20, 30, 100],
                    [10, 20, 100],
                ],
                [
                    [10, 30, 100],
                ], 2
            ],
            /**
             * 6a)
             * -a===b--a==b-
             * -a======b----
             */
            [
                [
                    [10, 20, 100],
                    [25, 30, 100],
                    [10, 25, 100],
                ],
                [
                    [10, 30, 100],
                ], 2
            ],
            [
                [
                    [10, 20, 75],
                    [25, 30, 100],
                    [10, 25, 100],
                ],
                [
                    [10, 30, 100],
                ], 2
            ],
            [
                [
                    [10, 20, 100],
                    [25, 30, 75],
                    [10, 25, 100],
                ],
                [
                    [10, 25, 100],
                    [25, 30, 75],
                ], 1
            ],
            [
                [
                    [10, 20, 75],
                    [25, 30, 75],
                    [10, 25, 100],
                ],
                [
                    [10, 25, 100],
                    [25, 30, 75],
                ], 1
            ],
            /**
             * 6b)
             * -a==b-a==b-
             * -a=======b-
             */
            [
                [
                    [10, 20, 100],
                    [25, 30, 100],
                    [10, 30, 100],
                ],
                [
                    [10, 30, 100],
                ], 2
            ],
            [
                [
                    [10, 20, 75],
                    [25, 30, 100],
                    [10, 30, 100],
                ],
                [
                    [10, 30, 100],
                ], 2
            ],
            [
                [
                    [10, 20, 100],
                    [25, 30, 75],
                    [10, 30, 100],
                ],
                [
                    [10, 30, 100],
                ], 2
            ],
            [
                [
                    [10, 20, 75],
                    [25, 30, 75],
                    [10, 30, 100],
                ],
                [
                    [10, 30, 100],
                ], 2
            ],
            /**
             * 6с)
             * -a==b-a=b---
             * -a========b-
             */
            [
                [
                    [10, 20, 100],
                    [23, 26, 100],
                    [10, 30, 100],
                ],
                [
                    [10, 30, 100],
                ], 2
            ],
            [
                [
                    [10, 20, 75],
                    [23, 26, 100],
                    [10, 30, 100],
                ],
                [
                    [10, 30, 100],
                ], 2
            ],
            [
                [
                    [10, 20, 100],
                    [23, 26, 75],
                    [10, 30, 100],
                ],
                [
                    [10, 30, 100],
                ], 2
            ],
            [
                [
                    [10, 20, 75],
                    [23, 26, 75],
                    [10, 30, 100],
                ],
                [
                    [10, 30, 100],
                ], 2
            ],
            /**
             * 6d)
             * -a==с==b----
             * -a========b-
             */
            [
                [
                    [10, 20, 100],
                    [20, 26, 75],
                    [10, 30, 100],
                ],
                [
                    [10, 30, 100],
                ], 2
            ],
            [
                [
                    [10, 20, 75],
                    [20, 26, 100],
                    [10, 30, 100],
                ],
                [
                    [10, 30, 100],
                ], 2
            ],
            /**
             * 6e)
             * -a==с=====b-
             * -a========b-
             */
            [
                [
                    [10, 20, 100],
                    [20, 30, 75],
                    [10, 30, 100],
                ],
                [
                    [10, 30, 100],
                ], 2
            ],
            [
                [
                    [10, 20, 75],
                    [20, 30, 100],
                    [10, 30, 100],
                ],
                [
                    [10, 30, 100],
                ], 2
            ],
            /**
             * 6f)
             * -a==с=====b-
             * -a======b---
             */
            [
                [
                    [10, 20, 75],
                    [20, 30, 100],
                    [10, 26, 100],
                ],
                [
                    [10, 30, 100],
                ], 2
            ],
            [
                [
                    [10, 20, 100],
                    [20, 30, 75],
                    [10, 26, 100],
                ],
                [
                    [10, 26, 100],
                    [26, 30, 75],
                ], 2
            ],
            /**
             * 6g)
             * -a==b-a===b-
             * -a======b---
             */
            [
                [
                    [10, 18, 100],
                    [22, 30, 100],
                    [10, 26, 100],
                ],
                [
                    [10, 30, 100],
                ], 2
            ],
            [
                [
                    [10, 18, 75],
                    [22, 30, 100],
                    [10, 26, 100],
                ],
                [
                    [10, 30, 100],
                ], 2
            ],
            [
                [
                    [10, 18, 100],
                    [22, 30, 75],
                    [10, 26, 100],
                ],
                [
                    [10, 26, 100],
                    [26, 30, 75],
                ], 2
            ],
            [
                [
                    [10, 18, 75],
                    [22, 30, 75],
                    [10, 26, 100],
                ],
                [
                    [10, 26, 100],
                    [26, 30, 75],
                ], 2
            ],
            /**
             * 7a)
             * ---a=b-a=b---
             * -a=========b-
             */
            [
                [
                    [14, 18, 100],
                    [22, 26, 100],
                    [10, 30, 100],
                ],
                [
                    [10, 30, 100],
                ], 2
            ],
            [
                [
                    [14, 18, 75],
                    [22, 26, 100],
                    [10, 30, 100],
                ],
                [
                    [10, 30, 100],
                ], 2
            ],
            [
                [
                    [14, 18, 100],
                    [22, 26, 75],
                    [10, 30, 100],
                ],
                [
                    [10, 30, 100],
                ], 2
            ],
            [
                [
                    [14, 18, 75],
                    [22, 26, 75],
                    [10, 30, 100],
                ],
                [
                    [10, 30, 100],
                ], 2
            ],
            /**
             * 7b)
             * ---a=c=b---
             * -a=========b-
             */
            [
                [
                    [14, 20, 100],
                    [20, 26, 75],
                    [10, 30, 100],
                ],
                [
                    [10, 30, 100],
                ], 2
            ],
            [
                [
                    [14, 20, 75],
                    [20, 26, 100],
                    [10, 30, 100],
                ],
                [
                    [10, 30, 100],
                ], 2
            ],
            /**
             * 7c)
             * ---a==c====b-
             * -a=========b-
             */
            [
                [
                    [14, 20, 100],
                    [20, 30, 75],
                    [10, 30, 100],
                ],
                [
                    [10, 30, 100],
                ], 2
            ],
            [
                [
                    [14, 20, 75],
                    [20, 30, 100],
                    [10, 30, 100],
                ],
                [
                    [10, 30, 100],
                ], 2
            ],
            /**
             * 7d)
             * ---a==c====b-
             * -a=======b---
             */
            [
                [
                    [14, 20, 75],
                    [20, 30, 100],
                    [10, 26, 100],
                ],
                [
                    [10, 30, 100],
                ], 2
            ],
            [
                [
                    [14, 20, 100],
                    [20, 30, 75],
                    [10, 26, 100],
                ],
                [
                    [10, 26, 100],
                    [26, 30, 75],
                ], 2
            ],
            /**
             * 7e)
             * ---a=b-a==b-
             * -a========b-
             */
            [
                [
                    [14, 20, 100],
                    [26, 30, 100],
                    [10, 30, 100],
                ],
                [
                    [10, 30, 100],
                ], 2
            ],
            [
                [
                    [14, 20, 75],
                    [26, 30, 100],
                    [10, 30, 100],
                ],
                [
                    [10, 30, 100],
                ], 2
            ],
            [
                [
                    [14, 20, 100],
                    [26, 30, 75],
                    [10, 30, 100],
                ],
                [
                    [10, 30, 100],
                ], 2
            ],
            [
                [
                    [14, 20, 75],
                    [26, 30, 75],
                    [10, 30, 100],
                ],
                [
                    [10, 30, 100],
                ], 2
            ],
            /**
             * 7f)
             * ---a=b-a====b-
             * -a========b---
             */
            [
                [
                    [14, 20, 100],
                    [24, 30, 100],
                    [10, 27, 100],
                ],
                [
                    [10, 30, 100],
                ], 2
            ],
            [
                [
                    [14, 20, 75],
                    [24, 30, 100],
                    [10, 27, 100],
                ],
                [
                    [10, 30, 100],
                ], 2
            ],
            [
                [
                    [14, 20, 100],
                    [24, 30, 75],
                    [10, 27, 100],
                ],
                [
                    [10, 27, 100],
                    [27, 30, 75],
                ], 2
            ],
            [
                [
                    [14, 20, 75],
                    [24, 30, 75],
                    [10, 27, 100],
                ],
                [
                    [10, 27, 100],
                    [27, 30, 75],
                ], 2
            ],
            /**
             * 7g)
             * ---a=b---a=b-
             * -a=======b---
             */
            [
                [
                    [14, 20, 100],
                    [26, 30, 100],
                    [10, 26, 100],
                ],
                [
                    [10, 30, 100],
                ], 2
            ],
            [
                [
                    [14, 20, 75],
                    [26, 30, 100],
                    [10, 26, 100],
                ],
                [
                    [10, 30, 100],
                ], 2
            ],
            [
                [
                    [14, 20, 100],
                    [26, 30, 75],
                    [10, 26, 100],
                ],
                [
                    [10, 26, 100],
                    [26, 30, 75],
                ], 1
            ],
            [
                [
                    [14, 20, 75],
                    [26, 30, 75],
                    [10, 26, 100],
                ],
                [
                    [10, 26, 100],
                    [26, 30, 75],
                ], 1
            ],
            /**
             * 8a)
             * ---a==c==b-
             * -a====b----
             */
            [
                [
                    [14, 20, 75],
                    [20, 30, 100],
                    [10, 20, 100],
                ],
                [
                    [10, 30, 100],
                ], 2
            ],
            [
                [
                    [14, 20, 100],
                    [20, 30, 75],
                    [10, 20, 100],
                ],
                [
                    [10, 20, 100],
                    [20, 30, 75],
                ], 1
            ],

            /**
             * Several triole-interval intersections
             *
             * Z1)
             * -a===b-a=b-a===b-
             * ---a=========b---
             */
            [
                [
                    [1,  10, 100],
                    [15, 20, 100],
                    [23, 30, 100],
                    [5,  26, 100],
                ],
                [
                    [1, 30, 100],
                ], 2
            ],
            [
                [
                    [1,  10, 75],
                    [15, 20, 100],
                    [23, 30, 100],
                    [5,  26, 100],
                ],
                [
                    [1, 5,  75],
                    [5, 30, 100],
                ], 3
            ],
            [
                [
                    [1,  10, 100],
                    [15, 20, 100],
                    [23, 30, 75],
                    [5,  26, 100],
                ],
                [
                    [1, 26, 100],
                    [26,30, 75],
                ], 3
            ],
            [
                [
                    [1,  10, 75],
                    [15, 20, 100],
                    [23, 30, 75],
                    [5,  26, 100],
                ],
                [
                    [1, 5, 75],
                    [5, 26, 100],
                    [26,30, 75],
                ], 3
            ],
            [
                [
                    [1,  10, 75],
                    [15, 20, 75],
                    [23, 30, 75],
                    [5,  26, 100],
                ],
                [
                    [1, 5, 75],
                    [5, 26, 100],
                    [26,30, 75],
                ], 3
            ],

            /**
             * Z2)
             * -a=b-a=b---a===b-
             * ---a=========b---
             */
            [
                [
                    [1,  5, 100],
                    [10,15, 100],
                    [20,30, 100],
                    [5, 26, 100],
                ],
                [
                    [1, 30, 100],
                ], 2
            ],
            [
                [
                    [1,  5, 75],
                    [10,15, 100],
                    [20,30, 100],
                    [5, 26, 100],
                ],
                [
                    [1, 5,  75],
                    [5, 30, 100],
                ], 2
            ],
            [
                [
                    [1,  5, 100],
                    [10,15, 100],
                    [20,30, 75],
                    [5, 26, 100],
                ],
                [
                    [1, 26, 100],
                    [26,30, 75],
                ], 3
            ],
            [
                [
                    [1,  5, 75],
                    [10,15, 100],
                    [20,30, 75],
                    [5, 26, 100],
                ],
                [
                    [1, 5,  75],
                    [5, 26, 100],
                    [26,30, 75],
                ], 2
            ],
            [
                [
                    [1,  5, 75],
                    [10,15, 75],
                    [20,30, 75],
                    [5, 26, 100],
                ],
                [
                    [1, 5,  75],
                    [5, 26, 100],
                    [26,30, 75],
                ], 2
            ],

            /**
             * Z3
             * -a=c==b---a===b--
             * ---a=========b---
             */
            [
                [
                    [1,  5, 100],
                    [5, 15, 75],
                    [20,30, 100],
                    [5, 26, 100],
                ],
                [
                    [1, 30, 100],
                ], 2
            ],
            [
                [
                    [1,  5, 75],
                    [5, 15, 100],
                    [20,30, 100],
                    [5, 26, 100],
                ],
                [
                    [1, 5,  75],
                    [5, 30, 100],
                ], 2
            ],
            [
                [
                    [1,  5, 75],
                    [5, 15, 100],
                    [20,30, 75],
                    [5, 26, 100],
                ],
                [
                    [1, 5,  75],
                    [5, 26, 100],
                    [26,30, 75],
                ], 2
            ],
            [
                [
                    [1,  5, 100],
                    [5, 15, 75],
                    [20,30, 75],
                    [5, 26, 100],
                ],
                [
                    [1, 26, 100],
                    [26,30, 75],
                ], 3
            ],

            /**
             * Z4)
             * -a==b--a==b--a==b-
             * ----a========b----
             */
            [
                [
                    [1,  5, 100],
                    [10,15, 100],
                    [20,30, 100],
                    [5, 20, 100],
                ],
                [
                    [1, 30, 100],
                ], 2
            ],
            [
                [
                    [1,  5, 75],
                    [10,15, 100],
                    [20,30, 100],
                    [5, 20, 100],
                ],
                [
                    [1, 5, 75],
                    [5, 30, 100],
                ], 2
            ],
            [
                [
                    [1,  5, 100],
                    [10,15, 100],
                    [20,30, 75],
                    [5, 20, 100],
                ],
                [
                    [1, 20, 100],
                    [20,30, 75],
                ], 2
            ],
            [
                [
                    [1,  5, 75],
                    [10,15, 100],
                    [20,30, 75],
                    [5, 20, 100],
                ],
                [
                    [1, 5,  75],
                    [5, 20, 100],
                    [20,30, 75],
                ], 1
            ],

            /**
             * Some crazy stuff
             *
             * -a=b-a=b-a=b-a=b-
             * ---a=========b---
             */
            [
                [
                    [1, 5,  100],
                    [8, 12, 100],
                    [15,18, 100],
                    [25,30, 100],
                    [5, 25, 100],
                ],
                [
                    [1, 30, 100],
                ], 2
            ],
            [
                [
                    [1, 5,  75],
                    [8, 12, 100],
                    [15,18, 100],
                    [25,30, 100],
                    [5, 25, 100],
                ],
                [
                    [1, 5,  75],
                    [5, 30, 100],
                ], 2
            ],
            [
                [
                    [1, 5,  100],
                    [8, 12, 100],
                    [15,18, 100],
                    [25,30, 75],
                    [5, 25, 100],
                ],
                [
                    [1, 25, 100],
                    [25,30, 75],
                ], 2
            ],
            [
                [
                    [1, 5,  75],
                    [8, 12, 100],
                    [15,18, 100],
                    [25,30, 75],
                    [5, 25, 100],
                ],
                [
                    [1, 5,  75],
                    [5, 25, 100],
                    [25,30, 75],
                ], 2
            ],
            [
                [
                    [1, 5,  75],
                    [8, 12, 75],
                    [15,18, 75],
                    [25,30, 75],
                    [5, 25, 100],
                ],
                [
                    [1, 5,  75],
                    [5, 25, 100],
                    [25,30, 75],
                ], 2
            ],
        ];

    }

    /**
     * @test
     * @throws Exception
     */
    public function testAddIntervals() {
        $this->prepare();

        $data = $this->prepareTestIntervals();

        foreach($data as $case) {

            $this->truncateTestTable();

            $debug = "";

            /**
             * @var Interval $interval
             */
            $i = 0;
            foreach($case["add"] as $interval) {
                $i++;
                $this->model->getDbManager()->getProfiler()->reset();

                try {
                    $this->model->inject($interval);
                } catch (Exception $e) {
                    echo "Error when adding $interval: " . $e->getMessage() . "\n";
                    print_r($this->model->getPool());
                    $this->assertEquals(true, false);
                }

                $profiler = $this->model->getDbManager()->getProfiler();
                $modifiedQueriesCount = $profiler->getModifyingQueryCount();

                $debug .= "$i. Adding $interval \n" .
                $profiler->getResultsAsString(true) . "\n";
            }

            $resultIntervals = $this->model->getIntervals(["date_start", "date_end", "price", "property_id"]);

            $this->assertEquals($case["expected"], $resultIntervals,
                "Result intervals not equals expected \n$debug"
            );

            if($case["modifications"] === false) {
                echo "Added $interval in $modifiedQueriesCount data mutations\n";
            } else {
                $this->assertEquals($case["modifications"], $modifiedQueriesCount,
                    "DB modification queries $modifiedQueriesCount not equals expected {$case["modifications"]} when adding $interval\n"
                    .$profiler->getResultsAsString()
                );
            }
        }
    }

    /**
     * @return array
     */
    private function prepareTestIntervals() {
        $data = $this->dataProvider();
        $result = [];
        foreach($data as $testCase) {
            $intervalsToAdd    = [];
            $expectedIntervals = [];
            foreach($testCase[0] as $row) {
                $intervalsToAdd[] = $this->createInterval($row);
            }
            foreach($testCase[1] as $row) {
                $expectedIntervals[] = $this->createInterval($row);
            }
            $result[] = [
                "add"      => $intervalsToAdd,
                "expected" => $expectedIntervals,
                "modifications" => $testCase[2],
            ];
        }

        return $result;
    }

    /**
     * Clear test table
     */
    private function truncateTestTable() {
        $this->model->getDbManager()->query("TRUNCATE TABLE `".$this->model->getTable()."`");
    }


    /**
     * Init interval object from test data
     * @param $array
     * @return Interval
     */
    private function createInterval($array) {

        $ds = $array[0];
        if(is_numeric($ds)) {
            $ds = "2018-10-$ds";
        }
        $de = $array[1];
        if(is_numeric($de)) {
            $de = "2018-10-$de";
        }

        $interval = new Interval([
            "date_start"  => $ds,
            "date_end"    => $de,
            "price"       => $array[2],
            "property_id" => IntervalModel::DEFAULT_PROPERTY_ID
        ]);

        return $interval;
    }
}
